<html>

<head>
	<title>Music Recommendation and Streaming system</title>
	<!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
	<script src="https://www.gstatic.com/firebasejs/5.11.0/firebase-app.js"></script>

	<!-- Add Firebase products that you want to use -->
	<script src="https://www.gstatic.com/firebasejs/5.11.0/firebase.js"></script>
	<script>
		var config = {
			apiKey: "AIzaSyAe1UO7_QjlLTGqG_3gWTLbPJrlGsCJio8",
			authDomain: "finalyearproject-f9cf5.firebaseapp.com",
			databaseURL: "https://finalyearproject-f9cf5.firebaseio.com",
			projectId: "finalyearproject-f9cf5",
			storageBucket: "finalyearproject-f9cf5.appspot.com",
			messagingSenderId: "70233672380"
		};
		firebase.initializeApp(config);
	</script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

	<link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" type="text/css">
	<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css">
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

	<script>
		firebase.auth().onAuthStateChanged(function(user) {
			if (user) {
				document.getElementById("lscallbutton").style.display = "none";
				document.getElementById("signoutbtn").style.display = "block";
			} else {
				document.getElementById("lscallbutton").style.display = "block";
				document.getElementById("signoutbtn").style.display = "none";
			}
		});
	</script>
	<div id="myPage" data-spy="scroll" data-target=".navbar" data-offset="60">

		<nav class="navbar navbar-default navbar-fixed-top">
			<div class="container">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<a class="navbar-brand" href="#myPage">Explore Music</a>
				</div>
				<div class="collapse navbar-collapse" id="myNavbar">
					<ul class="nav navbar-nav navbar-right">
						<li><a href="index.html#trending_music">Trending Music</a></li>
						<li><a href="index.html#about_us">About us</a></li>
						<li><a href="index.html#contact">CONTACT</a></li>
						<li><a href="index1.html">Music Library</a></li>
						<li><button id="lscallbutton" type="button" class="btn navbar-btn btn-success" data-toggle="modal" data-target="#loginsignuppopup">Login/Signup</button></li>
						<li><button id="signoutbtn" type="button" class="btn navbar-btn btn-danger" style="display: none" onclick="signoutuser(1);">Sign-out</button></li>
					</ul>
				</div>
			</div>
		</nav>
	</div>

	<div id="loginsignuppopup" class="modal fade" role="dialog" style="margin-top: 30px">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" onclick="clearallfields();">&times;</button>
					<h4 class="modal-title">Login/Signup</h4>
				</div>
				<div class="modal-body">
					<ul class="nav nav-tabs">
						<li class="active"><a data-toggle="tab" href="#flogin" onclick="togglelsbutton('l');">Login</a></li>
						<li><a data-toggle="tab" href="#fsignup" onclick="togglelsbutton('s');">Sign-up</a></li>
					</ul>
					<div class="tab-content">
						<div id="flogin" class="tab-pane fade in active">
							<h3>Login</h3>
							<div id="lstatus" class="alert alert-success" style="display: none">
								<strong id="lstatusstrong">Success!</strong> Indicates a successful or positive action.
							</div>
							<hr>
							<div class="input-group">
								<span class="input-group-addon"><i class="glyphicon glyphicon-user"></i></span>
								<input id="lemail" type="text" class="form-control" name="lemail" placeholder="Email">
							</div>
							<div class="input-group">
								<span class="input-group-addon"><i class="glyphicon glyphicon-lock"></i></span>
								<input id="lpass" type="password" class="form-control" name="lpass" placeholder="Password">
							</div>
							<br>
						</div>
						<div id="fsignup" class="tab-pane fade">
							<h3>Signup</h3>
							<div id="sstatus" class="alert alert-success" style="display:none">
								<strong id="sstatusstrong">Success!</strong> Indicates a successful or positive action.
							</div>
							<hr>
							<div class="input-group">
								<span class="input-group-addon"><i class="glyphicon glyphicon-user"></i></span>
								<input id="sname" type="text" class="form-control" name="sname" placeholder="Name">
							</div>
							<div class="input-group">
								<span class="input-group-addon"><i class="glyphicon glyphicon-envelope"></i></span>
								<input id="semail" type="text" class="form-control" name="semail" placeholder="Email">
							</div>
							<div class="input-group">
								<span class="input-group-addon"><i class="glyphicon glyphicon-phone"></i></span>
								<input id="sphone" type="number" class="form-control" name="sphone" placeholder="Number">
							</div>
							<div class="input-group">
								<span class="input-group-addon"><i class="glyphicon glyphicon-lock"></i></span>
								<input id="spass" type="password" class="form-control" name="spass" placeholder="Password">
							</div>
							<div class="input-group">
								<span class="input-group-addon"><i class="glyphicon glyphicon-lock"></i></span>
								<input id="scpass" type="password" class="form-control" name="scpass" placeholder="Confirm Password">
							</div>
							<br>
						</div>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button id="tgglelsbutton" type="button" class="btn btn-success" value="Login" onclick="validateform(tgglelsbutton.value);">Login</button>
			</div>
		</div>
	</div>
	</div>
	<div id="loginsuccessmodal" class="modal fade" role="dialog" style="margin-top: 50px">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				<div class="modal-body">
					<div class="alert alert-success">
						<strong>Success!</strong> Login Successfully!
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>

	<div id="signoutalert" class="modal fade" role="dialog" style="margin-top: 50px">
		<div class="modal-dialog">

			<!-- Modal content-->
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				<div class="modal-body">
					<div class="alert alert-success">
						<strong>Success!</strong> Signout Successfully!
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>
	<link href="css/test.css" rel="stylesheet">
	<script src="js/my_js.js"></script>
	<link href="css/musiclibrarystyling.css" rel="stylesheet" />

</head>
<script>
	var loaded = "false";
	var songloaded = "false";
	var musicidarray = [];
	var musicpaircontentarray = [];
	var currerntlyplayingartistid;
	var currentsongarrayindex;
	var db = firebase.firestore();
	var popularsongsrefarray = [];
	var toggleonline = "true";
	var currentlyplayingartistname;
	var addedtoplaylist = [];
	var global_paginationStartIndex;
	var global_paginationEndIndex;
	var global_paginationCurrentIndex;
	var currentfirebaseuser;
	var currentfirebaseuserid;
	var playlistnames = [];
	var tempsearcharray = [];
	var storage = firebase.storage();
	var storageRef = storage.refFromURL("gs://finalyearproject-f9cf5.appspot.com/");
	var global_playingSongId;


	window.addEventListener('online', updateinternetfailure("online"));
	window.addEventListener('offline', updateinternetfailure("offline"));

	firebase.auth().onAuthStateChanged(function(user) {
		if (user) {
			currentfirebaseuser = user;
			currentfirebaseuserid = user.uid;
			generateUserPlaylists();
		} else {
			currentfirebaseuser = null;
			currentfirebaseuserid = null;
			destroyUserPlaylist();
		}
	});

	function generateUserPlaylists() {
		var p = document.getElementById("playlists");
		while (p.hasChildNodes()) {
			p.removeChild(p.firstChild);
		}
		if (currentfirebaseuserid != null) {
			db.collection("Users").doc(currentfirebaseuserid).get().then(function(doc) {
				playlistnames = doc.get("PlaylistArrayFields");
				if (playlistnames != null) {
					var index = playlistnames.indexOf('Default');
					playlistnames.splice(index, 1);
					if (playlistnames.length == 0) {
						var p = document.getElementById("playlists");
						var txt = document.createElement('p');
						txt.innerHTML = "Create new playlist and add songs to it by using the button below";
						p.append(txt);
					}
					for (var f = 0; f < playlistnames.length; f++) {
						console.log(playlistnames[f] + ",");
					}
					for (var i = 0; i < playlistnames.length; i++) {
						playListGenarator(playlistnames[i]);
					}
				}
			});

		} else {
			console.log("something wrong");
		}
	}

	function destroyUserPlaylist() {
		playlistnames = [];
		//initialise();
		var p = document.getElementById("playlists");
		while (p.hasChildNodes()) {
			p.removeChild(p.firstChild);
		}
		var txt = document.createElement('p');
		txt.innerHTML = "Sign in to see playlists";
		p.append(txt);
	}

	function playlistModalGenerator(title) {
		var maincontainer = document.getElementById("userplaylistcontainer");
		var subcontainer;
		var pname;
		var btn;
		var sp;
		subcontainer = document.createElement('div');
		subcontainer.className = "track";
		subcontainer.setAttribute("style", "display:flex;flex-flow:row wrap;");

		pname = document.createElement("p");
		pname.className = "track__title";
		pname.style.color = "white";
		pname.innerHTML = title;
		subcontainer.appendChild(pname);

		btn = document.createElement('button');
		btn.className = "track__explicit";
		btn.id = title + "*";
		btn.setAttribute("style", "background:#1ed760");

		sp = document.createElement('span');
		sp.style.color = "#fff";
		sp.innerHTML = "Click to add to playlist";

		btn.appendChild(sp);

		subcontainer.appendChild(btn);
		var pn;
		maincontainer.appendChild(subcontainer);
		btn.addEventListener('click', function() {
			var actualname = this.id.substring(0, this.id.length - 1);

			pn = "PL" + actualname;
			var y = 0;
			for (y = 0; y < addedtoplaylist.length; y++) {
				addSongstoPLaylistInDatabase(pn, addedtoplaylist[y]);
			}
			console.log("updated playlists");
			openstatusmodal("Successfully added song into your playlist", "green");
			refreshcheckboxes();
			closemodal();
		});
	}

	function refreshcheckboxes() {
		var v1;
		var v2;
		for (var a = 0; a < addedtoplaylist.length; a++) {
			v1 = document.getElementById(addedtoplaylist[a] + "1");
			v2 = document.getElementById(addedtoplaylist[a] + "2");
			if (v1 != null) {
				v1.innerHTML = "check_box_outline_blank";
			}
			if (v2 != null) {
				v2.innerHTML = "check_box_outline_blank";
			}
		}
		addedtoplaylist = [];
	}

	function addSongstoPLaylistInDatabase(pn, sid) {
		var dref = db.collection("Users").doc(currentfirebaseuserid);
		dref.update({
				[pn]: firebase.firestore.FieldValue.arrayUnion(sid)
			})
			.then(function() {
				console.log("updated sid");
			})
			.catch(function(error) {
				console.error("Error adding document: ", error);
			});
	}

	function generatePlaylistModal() {
		var p = document.getElementById("userplaylistcontainer");
		while (p.hasChildNodes()) {
			p.removeChild(p.firstChild);
		}
		var maincontainer = document.getElementById("userplaylistcontainer");
		if (currentfirebaseuser != null) {
			var i;
			for (i = 0; i < playlistnames.length; i++) {
				playlistModalGenerator(playlistnames[i]);
			}
		} else {
			var error = document.createElement('h1');
			error.innerHTML = "Sign in to create and play playlists";
			maincontainer.appendChild(error);
		}

	}

	function updateinternetfailure(str) {
		if (str == "offline" && loaded == "true") {
			toggleonline = "false";
			openstatusmodal("No Internet.Reconnect to stream songs", "red");
		} else if (str == "online" && toggleonline == "false") {
			toggleonline = "true";
			openstatusmodal("You are back online.Continue to stream songs", "green");
		}
	}

	function updateArtistImage(artistimageurl, artistname, url2) {
		currentlyplayingartistname = artistname;
		document.getElementById("currenttopartistplayingname").innerHTML = artistname;
		var image = document.getElementById("artistimage");
		var parent = image.parentNode;
		var artistimage = document.createElement('img');
		artistimage.src = artistimageurl;
		artistimage.id = "artistimage";
		while (parent.hasChildNodes()) {
			parent.removeChild(parent.firstChild);
		}
		parent.appendChild(artistimage);

		var img = document.getElementById("currentplaylistimage");
		var par = img.parentNode;
		var artimg = document.createElement('img');
		artimg.src = url2;
		artimg.id = "currentplaylistimage";
		while (par.hasChildNodes()) {
			par.removeChild(par.firstChild);
		}
		par.appendChild(artimg);

	}

	function playSameArtistSongs(str) {
		if (str != 'default') {
			currerntlyplayingartistid = str;
			db.collection("ArtistIdNamePairs").doc('\'' + str + '\'').get().then(function(doc) {
				currentlyplayingartistname = doc.data().FirestoreArtistIdModel.artist_name;
				document.getElementById("currentplayingplaylistname").innerHTML = doc.data().FirestoreArtistIdModel.artist_name + " Songs";
			});
		} else {
			document.getElementById("currentplayingplaylistname").innerHTML = currentlyplayingartistname + " Songs";
		}

		musicidarray = [];
		musicpaircontentarray = [];
		db.collection("MusicIdNamePairs").where('FireStoreMusicValueModel.artist_id', '==', currerntlyplayingartistid).get().then((querySnapshot) => {
			querySnapshot.forEach((doc) => {
				console.log("--------------------------->" + doc.data().FireStoreMusicValueModel.artist_id);
				musicidarray.push(doc.id);
				musicpaircontentarray.push(doc);
			});
			var cont = document.getElementById("playListContainer");
			while (cont.hasChildNodes()) {
				cont.removeChild(cont.firstChild);
			}
			currentlyPlayingListGenerator();
			currentsongarrayindex = 0;
			initialiseplay("play");
		});
	}

	function initialiseplay(isplay) //When called after currentsongarrayindex is set,reads the document object snapshot and plays the particular song corresponding to the array index
	{
		console.log("Inside initialise");
		var dref = musicpaircontentarray[currentsongarrayindex];
		console.log("Track ID is:" + dref.id);
		storageRef.child('SongFiles/' + dref.id + '(song).mp3').getDownloadURL().then(function(songUrl) {
			var downloadurl = songUrl;
			storageRef.child('SongThumbnails/smallThumbnail/' + dref.id + '(S).jpg').getDownloadURL().then(function(songThumbnailUrl) {
				var songimageurl = songThumbnailUrl;
				storageRef.child('SongThumbnails/largeThumbnail/' + dref.id + '(L).jpg').getDownloadURL().then(function(songThumbnailUrlLarge) {
					var songImageUrlLarge = songThumbnailUrlLarge;
					var songname = dref.data().FireStoreMusicValueModel.song_title;
					var artistid = dref.data().FireStoreMusicValueModel.artist_id;
					fillSameArtistSongs(artistid);
					fillRecommendedSongs(dref.id);
					//put current artist details pending here
					db.collection("ArtistIdNamePairs").doc('\'' + artistid + '\'').get().then(function(doc) {
						name = doc.data().FirestoreArtistIdModel.artist_name;
						var artistImageUrl1 = doc.data().FirestoreArtistIdModel.url1;
						var artistImageUrl2 = doc.data().FirestoreArtistIdModel.url2;
						updateArtistImage(artistImageUrl1, name, artistImageUrl2);
						setSongDetails(songname, name, songimageurl, songImageUrlLarge, dref.id);
						playSongById(downloadurl, isplay);
					});
				}).catch(function(error) {
					var songImageUrlLarge = songimageurl;
					var songname = dref.data().FireStoreMusicValueModel.song_title;
					var artistid = dref.data().FireStoreMusicValueModel.artist_name;
					fillSameArtistSongs(artistid);
					fillRecommendedSongs(dref.id);
					db.collection("ArtistIdNamePairs").doc('\'' + artistid + '\'').get().then(function(doc) {
						var name = doc.data().FirestoreArtistIdModel.artist_name;
						var artistImageUrl1 = doc.data().FirestoreArtistIdModel.url1;
						var artistImageUrl2 = doc.data().FirestoreArtistIdModel.url2;
						updateArtistImage(artistImageUrl1, name, artistImageUrl2);
						setSongDetails(songname, name, songimageurl, songImageUrlLarge, dref.id);
						playSongById(downloadurl, "play");
					});
				});
			}).catch(function(error) {

			});
		}).catch(function(error) {
			// Handle any errors
		});
	}
	$(window).bind("load", function() {
		loaded = "true";
		document.getElementById("songloadstatus").style.display = "none";
	});

	function popular_and_playListSongListGenerator(mode, title, artistname, imageurl, songid) {
		var maincontainer;
		if (mode == "p") {
			maincontainer = document.getElementById("songListContainer");
		} else {
			maincontainer = document.getElementById("playListContainer");
		}

		var songcontainer = document.createElement('div');
		songcontainer.className = "track";


		var songimagecontainer = document.createElement('div');
		songimagecontainer.className = "track__art";
		var songimage = document.createElement('img');
		songimage.src = imageurl;
		songimagecontainer.appendChild(songimage);
		songcontainer.appendChild(songimagecontainer);



		var addcontainer = document.createElement('div');
		addcontainer.className = "track__added";

		var icontainer = document.createElement('i');
		if (mode == "p") {
			icontainer.id = songid + "2";
		} else {
			icontainer.id = songid + "1";
		}
		icontainer.className = "material-icons";
		icontainer.innerHTML = "check_box_outline_blank";
		addcontainer.appendChild(icontainer);
		songcontainer.appendChild(addcontainer);


		var titlecontainer = document.createElement('div');
		titlecontainer.className = "track__title";
		var ti = document.createTextNode(title);
		titlecontainer.appendChild(ti);
		songcontainer.appendChild(titlecontainer);

		var explicitcontainer = document.createElement('button');
		explicitcontainer.className = "track__explicit";
		explicitcontainer.id = songid;
		explicitcontainer.setAttribute("style", "background:#1ed760");
		var spancontainer = document.createElement('span');
		spancontainer.className = "track__label";
		spancontainer.setAttribute("style", "color:#fff");
		var exp = document.createTextNode("Play");
		spancontainer.appendChild(exp);

		explicitcontainer.appendChild(spancontainer);
		songcontainer.appendChild(explicitcontainer);

		var playcontainer = document.createElement('div');
		playcontainer.className = "track__plays";
		var tplay = document.createTextNode(artistname);
		playcontainer.appendChild(tplay);
		//songcontainer.appendChild(playcontainer);
		titlecontainer.appendChild(playcontainer);

		var playAnimationContainer = document.createElement('div');
		playAnimationContainer.innerHTML = "<svg style='display:none;margin-left:15px;' id=animation" + songid + " width='16px' height='16px' viewBox='0 0 16 16' version='1.1'" +
			" xmlns='http://www.w3.org/2000/svg'" +
			"xmlns:xlink='http://www.w3.org/1999/xlink'>" +
			"<defs></defs>" +
			"<g id='icon-equalizer-anim' fill='#1ed760'>" +
			"<rect class='eq__bar' id='eq1' x='1' y='8' width='4' height='8'></rect>" +
			"<rect class='eq__bar' id='eq2' x='6' y='1' width='4' height='15'></rect>" +
			"<rect class='eq__bar' id='eq3' x='11' y='4' width='4' height='12'></rect>" +
			"</g>" +
			"</svg>";
		songcontainer.appendChild(playAnimationContainer);

		//maincontainer.appendChild(explicitcontainer);
		maincontainer.appendChild(songcontainer);

		explicitcontainer.addEventListener('click', function() {
			var sid = this.id;
			//this.getElementsByTagName('span')[0].innerHTML="Pause";
			//this.getElementsByTagName('svg')[0].style.display="inline";
			db.collection("MusicIdNamePairs").doc(sid).get().then(function(dref) {
				storageRef.child('SongFiles/' + dref.id + '(song).mp3').getDownloadURL().then(function(songUrl) {
					var downloadurl = songUrl;
					storageRef.child('SongThumbnails/smallThumbnail/' + dref.id + '(S).jpg').getDownloadURL().then(function(songThumbnailUrl) {
						var songimageurl = songThumbnailUrl;
						storageRef.child('SongThumbnails/largeThumbnail/' + dref.id + '(L).jpg').getDownloadURL().then(function(songThumbnailUrlLarge) {
							var songImageUrlLarge = songThumbnailUrlLarge;
							var songname = dref.data().FireStoreMusicValueModel.song_title;
							var artistid = dref.data().FireStoreMusicValueModel.artist_id;
							fillSameArtistSongs(artistid);
							fillRecommendedSongs(dref.id);
							db.collection("ArtistIdNamePairs").doc('\'' + artistid + '\'').get().then(function(doc) {
								var name = doc.data().FirestoreArtistIdModel.artist_name;
								var artistImageUrl1 = doc.data().FirestoreArtistIdModel.url1;
								var artistImageUrl2 = doc.data().FirestoreArtistIdModel.url2;
								updateArtistImage(artistImageUrl1, name, artistImageUrl2);
								setSongDetails(songname, name, songimageurl, songImageUrlLarge, dref.id);
								playSongById(downloadurl, "play");
							});
						}).catch(function(error) {
							var songImageUrlLarge = songimageurl;
							var songname = dref.data().FireStoreMusicValueModel.song_title;
							var artistid = dref.data().FireStoreMusicValueModel.artist_name;
							fillSameArtistSongs(artistid);
							fillRecommendedSongs(dref.id);
							db.collection("ArtistIdNamePairs").doc('\'' + artistid + '\'').get().then(function(doc) {
								var name = doc.data().FirestoreArtistIdModel.artist_name;
								var artistImageUrl1 = doc.data().FirestoreArtistIdModel.url1;
								var artistImageUrl2 = doc.data().FirestoreArtistIdModel.url2;
								updateArtistImage(artistImageUrl1, name, artistImageUrl2);
								setSongDetails(songname, name, songimageurl, songImageUrlLarge, dref.id);
								playSongById(downloadurl, "play");
							});
						});
					}).catch(function(error) {

					});
				}).catch(function(error) {

				});
			});
		});

		icontainer.addEventListener('click', function() {
			if (addedtoplaylist.length == 0) {
				document.getElementById("x").style.display = "block";
			}
			if (this.innerHTML == "check_box_outline_blank") {
				this.innerHTML = "check_box";
				addedtoplaylist.push(this.id.substring(0, this.id.length - 1));
			} else if (this.innerHTML == "check_box") {
				this.innerHTML = "check_box_outline_blank";
				//addedtoplaylist=arrayRemove(addedtoplaylist,this.id);
				var index = addedtoplaylist.indexOf(this.id.substring(0, this.id.length - 1));
				addedtoplaylist.splice(index, 1);
			}
			if (addedtoplaylist.length == 0) {
				document.getElementById("x").style.display = "none";
			}
			for (var i = 0; i < addedtoplaylist.length; i++) {
				console.log(addedtoplaylist[i] + ",");
			}
		});
	}


	function createSongDetails(mode, i) {
		return function() {
			var name;
			var artistname;
			var artistid;
			var url;
			if (mode == "p") {
				db.collection("MusicIdNamePairs").doc(popularsongsrefarray[i]).get().then(function(doc) {
					name = doc.data().FireStoreMusicValueModel.song_title;
					artistid = doc.data().FireStoreMusicValueModel.artist_id;
					storageRef.child('SongThumbnails/smallThumbnail/' + doc.id + '(S).jpg').getDownloadURL().then(function(songThumbnailUrl) {
						url = songThumbnailUrl;
						db.collection("ArtistIdNamePairs").doc('\'' + artistid + '\'').get().then(function(doc) {
							artistname = doc.data().FirestoreArtistIdModel.artist_name;
							popular_and_playListSongListGenerator("p", name, artistname, url, popularsongsrefarray[i]);
						});
					}).catch(function(error) {

					});
				});
			} else if (mode == "c") {
				db.collection("MusicIdNamePairs").doc(musicidarray[i]).get().then(function(doc) {
					name = doc.data().FireStoreMusicValueModel.song_title;
					artistid = doc.data().FireStoreMusicValueModel.artist_id;
					storageRef.child('SongThumbnails/smallThumbnail/' + doc.id + '(S).jpg').getDownloadURL().then(function(songThumbnailUrl) {
						url = songThumbnailUrl;
						db.collection("ArtistIdNamePairs").doc('\'' + artistid + '\'').get().then(function(doc) {
							artistname = doc.data().FirestoreArtistIdModel.artist_name;
							popular_and_playListSongListGenerator("c", name, artistname, url, musicidarray[i]);
						});
					}).catch(function(error) {

					});
				});
			}
		};
	}

	function addNewPlaylist() {
		var modal = document.getElementById('newplaylistmodal');
		modal.style.display = "block";
	}

	function closeplaylistmodal() {
		var modal = document.getElementById('newplaylistmodal');
		modal.style.display = "none";
	}

	function addPlaylistNametoDatabase(val) {
		console.log("inside playlist modal");
		var dref = db.collection("Users").doc(currentfirebaseuserid);
		dref.update({
			PlaylistArrayFields: firebase.firestore.FieldValue.arrayUnion(val)
		}).then(function() {
			console.log("added to firebase");
			openstatusmodal("Added Sucessfully", "green");
			closeplaylistmodal();
			generateUserPlaylists();
		});
	}

	function closestatusmodal() {
		var modal = document.getElementById('statusmodal');
		modal.style.display = "none";
		document.getElementById("statustext").innerHTML = "";
	}

	function openstatusmodal(txt, colour) {
		var modal = document.getElementById('statusmodal');
		modal.style.display = "block";
		document.getElementById("statustext").innerHTML = txt;
		if (colour == null) {
			document.getElementById("statustext").style.color = "black";
		} else {
			document.getElementById("statustext").style.color = colour;
		}
	}

	function searchdatabase(event, str) {
		tempsearcharray = [];
		var lowinp = str;
		var lowcomp;
		var flag = "false";
		var cont = document.getElementById("myDropdown");
		while (cont.hasChildNodes()) {
			cont.removeChild(cont.firstChild);
		}
		console.log(lowinp);

		db.collection("MusicIdNamePairs").where("FireStoreMusicValueModel.song_title", "==", lowinp).get().then((querySnapshot) => {
			querySnapshot.forEach((doc) => {
				flag = "true";
				tempsearcharray.push(doc);
				console.log(doc.id);
				for (var f = 0; f < tempsearcharray.length; f++) {
					var tid = tempsearcharray[f].id;
					storageRef.child('SongThumbnails/smallThumbnail/' + tempsearcharray[f].id + '(S).jpg').getDownloadURL().then(function(songThumbnailUrl) {
						var songimageurl = songThumbnailUrl;
						generatesearchedlist(songimageurl, lowinp, tid);
					});
				}
				if (event.keyCode == 13 && flag == "false") {
					closesearchmodal();
					openstatusmodal("No title matches in the Music Library", "red");
				} else if (flag == "false") {
					var maincontainer = document.getElementById("myDropdown");
					maincontainer.className = "tracks";

					var songcontainer = document.createElement('div');
					songcontainer.className = "track";
					songcontainer.style.color = "white";
					songcontainer.innerHTML = "No songs matching in music library";
					maincontainer.appendChild(songcontainer);
				}
			});
		});

		//db.collection("MusicIdNamePairs").get().then((querySnapshot) => {
		//	querySnapshot.forEach((doc) => {
		//		lowcomp = doc.data().FireStoreMusicValueModel.song_title.toLowerCase();
		//		if (lowinp.length >= 3) {
		//			if ((lowcomp.indexOf(lowinp)) != -1) {
		//				tempsearcharray.push(doc);
		//				flag = "true";
		//				console.log(lowinp, "matches", lowcomp);
		//			}
		//		} else if (lowinp.length != 0) {
		//			if ((lowcomp.startsWith(lowinp))) {
		//				tempsearcharray.push(doc);
		//				flag = "true";
		//				console.log(lowinp, "matches", lowcomp);
		//			}
		//		}
		//	});
		//	console.log(tempsearcharray.length);
		//	for (var f = 0; f < tempsearcharray.length; f++) {
		//		storageRef.child('SongThumbnails/smallThumbnail/' + tempsearcharray[f].id + '(S).jpg').getDownloadURL().then(function(songThumbnailUrl) {
		//				var songimageurl = songThumbnailUrl;
		//				generatesearchedlist(songimageurl, tempsearcharray[f].data().FireStoreMusicValueModel.song_title, tempsearcharray[f].id);
		//		});
		//	}
		//
		//	if (event.keyCode == 13 && flag == "false") {
		//		closesearchmodal();
		//		openstatusmodal("No title matches in the Music Library", "red");
		//	} else if (flag == "false") {
		//		var maincontainer = document.getElementById("myDropdown");
		//		maincontainer.className = "tracks";
		//
		//		var songcontainer = document.createElement('div');
		//		songcontainer.className = "track";
		//		songcontainer.style.color = "white";
		//		songcontainer.innerHTML = "No songs matching in music library";
		//		maincontainer.appendChild(songcontainer);
		//	}
		//});

	}

	function generatesearchedlist(imageurl, title, songid) {
		var maincontainer = document.getElementById("myDropdown");
		maincontainer.className = "tracks";

		var songcontainer = document.createElement('div');
		songcontainer.className = "track";


		var songimagecontainer = document.createElement('div');
		songimagecontainer.className = "track__art";
		var songimage = document.createElement('img');
		songimage.src = imageurl;
		songimagecontainer.appendChild(songimage);
		songcontainer.appendChild(songimagecontainer);



		var titlecontainer = document.createElement('div');
		titlecontainer.className = "track__title";
		var ti = document.createTextNode(title);
		titlecontainer.appendChild(ti);
		songcontainer.appendChild(titlecontainer);



		var explicitcontainer = document.createElement('button');
		explicitcontainer.className = "track__explicit";
		explicitcontainer.id = songid + "s";
		explicitcontainer.setAttribute("style", "background:#1ed760");
		var spancontainer = document.createElement('span');
		spancontainer.className = "track__label";
		spancontainer.setAttribute("style", "color:#fff");
		var exp = document.createTextNode("Play");
		spancontainer.appendChild(exp);
		explicitcontainer.appendChild(spancontainer);
		songcontainer.appendChild(explicitcontainer);


		//maincontainer.appendChild(explicitcontainer);
		maincontainer.appendChild(songcontainer);

		explicitcontainer.addEventListener('click', function() {
			closesearchmodal();
			var sid = this.id.substring(0, this.id.length - 1);
			db.collection("MusicIdNamePairs").doc(sid).get().then(function(dref) {
				storageRef.child('SongFiles/' + dref.id + '(song).mp3').getDownloadURL().then(function(songUrl) {
					var downloadurl = songUrl;
					storageRef.child('SongThumbnails/smallThumbnail/' + dref.id + '(S).jpg').getDownloadURL().then(function(songThumbnailUrl) {
						var songimageurl = songThumbnailUrl;
						storageRef.child('SongThumbnails/largeThumbnail/' + dref.id + '(L).jpg').getDownloadURL().then(function(songThumbnailUrlLarge) {
							var songImageUrlLarge = songThumbnailUrlLarge;
							var songname = dref.data().FireStoreMusicValueModel.song_title;
							var artistid = dref.data().FireStoreMusicValueModel.artist_id;
							fillSameArtistSongs(artistid);
							fillRecommendedSongs(dref.id);
							db.collection("ArtistIdNamePairs").doc('\'' + artistid + '\'').get().then(function(doc) {
								var name = doc.data().FirestoreArtistIdModel.artist_name;
								var artistImageUrl1 = doc.data().FirestoreArtistIdModel.url1;
								var artistImageUrl2 = doc.data().FirestoreArtistIdModel.url2;
								updateArtistImage(artistImageUrl1, name, artistImageUrl2);
								setSongDetails(songname, name, songimageurl, songImageUrlLarge, dref.id);
								playSongById(downloadurl, "play");
							});
						}).catch(function(error) {
							var songImageUrlLarge = songimageurl;
							var songname = dref.data().FireStoreMusicValueModel.song_title;
							var artistid = dref.data().FireStoreMusicValueModel.artist_name;
							fillSameArtistSongs(artistid);
							fillRecommendedSongs(dref.id);
							db.collection("ArtistIdNamePairs").doc('\'' + artistid + '\'').get().then(function(doc) {
								var name = doc.data().FirestoreArtistIdModel.artist_name;
								var artistImageUrl1 = doc.data().FirestoreArtistIdModel.url1;
								var artistImageUrl2 = doc.data().FirestoreArtistIdModel.url2;
								updateArtistImage(artistImageUrl1, name, artistImageUrl2);
								setSongDetails(songname, name, songimageurl, songImageUrlLarge, dref.id);
								playSongById(downloadurl, "play");
							});
						});
					}).catch(function(error) {

					});

				}).catch(function(error) {

				});
			});
		});
		//document.getElementById("myDropdown").classList.toggle("show");
	}

	function generatePopularSongsList() {
		var i = 0;
		var funcs = [];
		db.collection("Popular").doc("SongId").get().then(function(doc) {
			popularsongsrefarray = doc.get("IdArray");
			for (i = 0; i < popularsongsrefarray.length; i++) {
				funcs[i] = createSongDetails("p", i);
			}
			for (i = 0; i < popularsongsrefarray.length; i++) {
				funcs[i]();
			}
		});
	}

	function currentlyPlayingListGenerator() {
		var i = 0;
		var funcs = [];
		for (i = 0; i < musicidarray.length; i++) {
			funcs[i] = createSongDetails("c", i);
		}
		for (i = 0; i < musicidarray.length; i++) {
			funcs[i]();
		}
	}

	function init() {
		generatePopularSongsList();
		global_paginationCurrentIndex = 1;
		global_paginationStartIndex = 1;
		global_paginationEndIndex = 6;
	}

	function songplayedorpaused(mode) {
		if (loaded == "true" && songloaded == "true") {
			if (mode == 'play') {
				document.getElementById('audiosource').play();
				document.getElementById('showplay').style.display = "none";
				document.getElementById('showpause').style.display = "block";
				if (global_playingSongId != null && document.getElementById("animation" + global_playingSongId) != null) {
					document.getElementById("animation" + global_playingSongId).style.display = "inline";
				}
			} else if (mode == 'pause') {
				document.getElementById('audiosource').pause();
				document.getElementById('showplay').style.display = "block";
				document.getElementById('showpause').style.display = "none";
				if (global_playingSongId != null && document.getElementById("animation" + global_playingSongId) != null) {
					document.getElementById("animation" + global_playingSongId).style.display = "none";
				}
			}
		} else if (loaded == "false") {
			document.getElementById("songloadstatus").style.display = "block";
		} else if (songloaded == "false") {
			document.getElementById("songloadstatus").style.display = "block";
			document.getElementById("songloadstatus").innerHTML = "Song is loading...please wait";
		}
	}



	// Viewport Heights

	$(window).on("resize load", function() {

		var totalHeight = $(window).height();

		var headerHeight = $('.header').outerHeight();
		var footerHeight = $('.current-track').outerHeight();
		var playlistHeight = $('.playlist').outerHeight();
		var nowPlaying = $('.playing').outerHeight();

		var navHeight = totalHeight - (headerHeight + footerHeight + playlistHeight + nowPlaying);
		var artistHeight = totalHeight - (headerHeight + footerHeight);

		console.log(totalHeight);

		$(".navigation").css("height", navHeight);
		$(".artist").css("height", artistHeight);
		$(".social").css("height", artistHeight);

	});


	function songsBysameArtistGenerator(songid, title) {
		var maincontainer = document.getElementById("songsBySameArtistContainer");
		var songcontainer = document.createElement('div');
		songcontainer.className = "track";

		var titlecontainer = document.createElement('div');
		titlecontainer.className = "track__title";
		if (title.length > 20) {
			title = title.substring(0, 17);
			title = title + "...";
		}
		var ti = document.createTextNode(title);
		titlecontainer.appendChild(ti);
		songcontainer.appendChild(titlecontainer);

		var explicitcontainer = document.createElement('button');
		explicitcontainer.className = "track__explicit";
		explicitcontainer.id = songid;
		explicitcontainer.setAttribute("style", "background:#1ed760");
		var spancontainer = document.createElement('span');
		spancontainer.className = "track__label";
		spancontainer.setAttribute("style", "color:#fff");
		var exp = document.createTextNode("Play");
		spancontainer.appendChild(exp);
		explicitcontainer.appendChild(spancontainer);
		songcontainer.appendChild(explicitcontainer);

		maincontainer.appendChild(songcontainer);
		explicitcontainer.addEventListener('click', function() {
			var sid = this.id;
			db.collection("MusicIdNamePairs").doc(sid).get().then(function(dref) {
				storageRef.child('SongFiles/' + dref.id + '(song).mp3').getDownloadURL().then(function(songUrl) {
					var downloadurl = songUrl;
					storageRef.child('SongThumbnails/smallThumbnail/' + dref.id + '(S).jpg').getDownloadURL().then(function(songThumbnailUrl) {
						var songimageurl = songThumbnailUrl;
						storageRef.child('SongThumbnails/largeThumbnail/' + dref.id + '(L).jpg').getDownloadURL().then(function(songThumbnailUrlLarge) {
							var songImageUrlLarge = songThumbnailUrlLarge;
							var songname = dref.data().FireStoreMusicValueModel.song_title;
							var artistid = dref.data().FireStoreMusicValueModel.artist_id;
							fillSameArtistSongs(artistid);
							fillRecommendedSongs(dref.id);
							db.collection("ArtistIdNamePairs").doc('\'' + artistid + '\'').get().then(function(doc) {
								var name = doc.data().FirestoreArtistIdModel.artist_name;
								var artistImageUrl1 = doc.data().FirestoreArtistIdModel.url1;
								var artistImageUrl2 = doc.data().FirestoreArtistIdModel.url2;
								updateArtistImage(artistImageUrl1, name, artistImageUrl2);
								setSongDetails(songname, name, songimageurl, songImageUrlLarge, dref.id);
								playSongById(downloadurl, "play");
							});
						}).catch(function(error) {
							var songImageUrlLarge = songimageurl;
							var songname = dref.data().FireStoreMusicValueModel.song_title;
							var artistid = dref.data().FireStoreMusicValueModel.artist_id;
							fillSameArtistSongs(artistid);
							fillRecommendedSongs(dref.id);
							db.collection("ArtistIdNamePairs").doc('\'' + artistid + '\'').get().then(function(doc) {
								var name = doc.data().FirestoreArtistIdModel.artist_name;
								var artistImageUrl1 = doc.data().FirestoreArtistIdModel.url1;
								var artistImageUrl2 = doc.data().FirestoreArtistIdModel.url2;
								updateArtistImage(artistImageUrl1, name, artistImageUrl2);
								setSongDetails(songname, name, songimageurl, songImageUrlLarge, dref.id);
								playSongById(downloadurl, "play");
							});
						});
					});
				}).catch(function(error) {

				});
			});
		});
	}

	function fillSameArtistSongs(artistid) {
		currerntlyplayingartistid = artistid;
		var cont = document.getElementById("songsBySameArtistContainer");
		while (cont.hasChildNodes()) {
			cont.removeChild(cont.firstChild);
		}
		db.collection("MusicIdNamePairs").where("FireStoreMusicValueModel.artist_id", "==", artistid).get().then((querySnapshot) => {
			querySnapshot.forEach((doc) => {
				console.log("=================>" + doc.data().FireStoreMusicValueModel.artist_id);
				songsBysameArtistGenerator(doc.id, doc.data().FireStoreMusicValueModel.song_title);
			});
		});
	}

	function generateRecommendedSongs(songid, title, similarityscore) {
		console.log("song id is" + songid);
		var maincontainer = document.getElementById("recommendedSongsContainer");
		var songcontainer = document.createElement('div');
		songcontainer.className = "track";

		var titlecontainer = document.createElement('div');
		titlecontainer.className = "track__title";
		if (title.length > 20) {
			title = title.substring(0, 17);
			title = title + "...";
		}
		var ti = document.createTextNode(title);
		titlecontainer.appendChild(ti);
		songcontainer.appendChild(titlecontainer);

		var explicitcontainer = document.createElement('button');
		explicitcontainer.className = "track__explicit";
		explicitcontainer.id = songid;
		explicitcontainer.setAttribute("style", "background:#1ed760");
		var spancontainer = document.createElement('span');
		spancontainer.className = "track__label";
		spancontainer.setAttribute("style", "color:#fff");
		var exp = document.createTextNode("Play");
		spancontainer.appendChild(exp);
		explicitcontainer.appendChild(spancontainer);
		songcontainer.appendChild(explicitcontainer);

		maincontainer.appendChild(songcontainer);
		explicitcontainer.addEventListener('click', function() {
			var sid = this.id;
			db.collection("MusicIdNamePairs").doc(sid).get().then(function(dref) {
				storageRef.child('SongFiles/' + dref.id + '(song).mp3').getDownloadURL().then(function(songUrl) {
					var downloadurl = songUrl;
					storageRef.child('SongThumbnails/smallThumbnail/' + dref.id + '(S).jpg').getDownloadURL().then(function(songThumbnailUrl) {
						var songimageurl = songThumbnailUrl;
						storageRef.child('SongThumbnails/largeThumbnail/' + dref.id + '(L).jpg').getDownloadURL().then(function(songThumbnailUrlLarge) {
							var songImageUrlLarge = songThumbnailUrlLarge;
							var songname = dref.data().FireStoreMusicValueModel.song_title;
							var artistid = dref.data().FireStoreMusicValueModel.artist_id;
							fillSameArtistSongs(artistid);
							fillRecommendedSongs(dref.id);
							db.collection("ArtistIdNamePairs").doc('\'' + artistid + '\'').get().then(function(doc) {
								var name = doc.data().FirestoreArtistIdModel.artist_name;
								var artistImageUrl1 = doc.data().FirestoreArtistIdModel.url1;
								var artistImageUrl2 = doc.data().FirestoreArtistIdModel.url2;
								updateArtistImage(artistImageUrl1, name, artistImageUrl2);
								setSongDetails(songname, name, songimageurl, songImageUrlLarge, dref.id);
								playSongById(downloadurl, "play");
							});
						}).catch(function(error) {
							var songImageUrlLarge = songimageurl;
							var songname = dref.data().FireStoreMusicValueModel.song_title;
							var artistid = dref.data().FireStoreMusicValueModel.artist_id;
							fillSameArtistSongs(artistid);
							fillRecommendedSongs(dref.id);
							db.collection("ArtistIdNamePairs").doc('\'' + artistid + '\'').get().then(function(doc) {
								var name = doc.data().FirestoreArtistIdModel.artist_name;
								var artistImageUrl1 = doc.data().FirestoreArtistIdModel.url1;
								var artistImageUrl2 = doc.data().FirestoreArtistIdModel.url2;
								updateArtistImage(artistImageUrl1, name, artistImageUrl2);
								setSongDetails(songname, name, songimageurl, songImageUrlLarge, dref.id);
								playSongById(downloadurl, "play");
							});
						});
					});
				}).catch(function(error) {

				});
			});
		});
	}

	function fillRecommendedSongs(song_id) {
		console.log("Mode is:" + $('input[name=optradio]:checked', '#recommendationChoice').val() + " Song ID is:" + song_id);
		var maincontainer = document.getElementById("recommendedSongsContainer");
		while (maincontainer.hasChildNodes()) {
			maincontainer.removeChild(maincontainer.firstChild);
		}
		if ($('input[name=optradio]:checked', '#recommendationChoice').val() == "KNN") {
			db.collection("PredictionKNN").doc(song_id).get().then(function(dref) {
				var obj = dref.data().KNNPredictionMaps;
				mapSort1 = sortMapAndReturnTopFive(obj);
				for (var key of mapSort1.keys()) {
					db.collection("MusicIdNamePairs").doc(key).get().then(function(doc) {
						var songname = doc.data().FireStoreMusicValueModel.song_title;
						//console.log("Keys are:"+doc.id+"songname is:"+songname);
						generateRecommendedSongs(doc.id, songname, mapSort1[key]);
					});
				}
			});
		} else if ($('input[name=optradio]:checked', '#recommendationChoice').val() == "RNN") {
			db.collection("PredictionANN").doc(song_id).get().then(function(dref) {
				var obj = dref.data().ANNPredictionMaps;
				mapSort1 = sortMapAndReturnTopFive(obj);
				for (var key of mapSort1.keys()) {
					db.collection("MusicIdNamePairs").doc(key).get().then(function(doc) {
						var songname = doc.data().FireStoreMusicValueModel.song_title;
						//console.log("Keys are:"+doc.id+"songname is:"+songname);
						generateRecommendedSongs(doc.id, songname, mapSort1[key]);
					});
				}
			});
		} else if ($('input[name=optradio]:checked', '#recommendationChoice').val() == "RNN&KNN") {
			db.collection("PredictionANNmeanKNN").doc(song_id).get().then(function(dref) {
				var obj = dref.data().KNNandANNmeanPredictionMaps;
				mapSort1 = sortMapAndReturnTopFive(obj);
				for (var key of mapSort1.keys()) {
					db.collection("MusicIdNamePairs").doc(key).get().then(function(doc) {
						var songname = doc.data().FireStoreMusicValueModel.song_title;
						//console.log("Keys are:"+doc.id+"songname is:"+songname);
						generateRecommendedSongs(doc.id, songname, mapSort1[key]);
					});
				}
			});
		}
	}

	function sortMapAndReturnTopFive(obj) {
		var map = new Map();
		for (key in obj) {
			map.set(key, obj[key]);
		}
		const mapSort1 = new Map([...map.entries()].sort((a, b) => b[1] - a[1]));
		var i = 0;
		for (var ele of mapSort1.keys()) {
			i++;
			if (i > 5) {
				mapSort1.delete(ele);
			}
		}
		return mapSort1;
	}

	function playListGenarator(title) {
		var maincontainer = document.getElementById("playlists");
		var songcontainer = document.createElement('div');
		songcontainer.className = "track";

		var titlecontainer = document.createElement('div');
		titlecontainer.className = "track__title";
		var ti = document.createTextNode(title);
		titlecontainer.appendChild(ti);
		songcontainer.appendChild(titlecontainer);

		var explicitcontainer = document.createElement('button');
		explicitcontainer.className = "track__explicit";
		explicitcontainer.id = title;
		explicitcontainer.setAttribute("style", "background:#1ed760");
		var spancontainer = document.createElement('span');
		spancontainer.className = "track__label";
		spancontainer.setAttribute("style", "color:#fff");
		var exp = document.createTextNode("Play");
		spancontainer.appendChild(exp);
		explicitcontainer.appendChild(spancontainer);
		songcontainer.appendChild(explicitcontainer);

		maincontainer.appendChild(songcontainer);

		explicitcontainer.addEventListener('click', function() {
			var gid = this.id;
			var titleofplaylist = "PL" + this.id;
			console.log(this.id);
			db.collection("Users").doc(currentfirebaseuserid).get().then(function(dov) {
				//Here function should be written to play playlist songs
				musicidarray = [];
				musicidarray = dov.get(titleofplaylist);
				musicpaircontentarray = [];
				for (var g = 0; g < musicidarray.length; g++) {
					playlistActionHelper(g);
				}
				document.getElementById("currentplayingplaylistname").innerHTML = gid + " Songs";

				var cont = document.getElementById("playListContainer");
				while (cont.hasChildNodes()) {
					cont.removeChild(cont.firstChild);
				}
				currentlyPlayingListGenerator();
				currentsongarrayindex = 0;
				initialiseplay("play");
			});
		});
	}

	function playlistActionHelper(g) {
		db.collection("MusicIdNamePairs").get().then((querySnapshot) => {
			querySnapshot.forEach((doc) => {
				if (doc.id == musicidarray[g]) {
					musicpaircontentarray.push(doc);
				}
			});
		});
	}


	// Collapse Toggles

	$(".navigation__list__header").on("click", function() {

		$(this).toggleClass("active");

	});


	// Media Queries

	$(window).on("resize load", function() {
		if ($(window).width() <= 768) {

			$(".collapse").removeClass("in");

			$(".navigation").css("height", "auto");

			$(".artist").css("height", "auto");

		}
	});

	$(window).on("resize load", function() {
		if ($(window).width() > 768) {

			$(".collapse").addClass("in");

		}
	});

	function doAllInitialization() {
		init();
		initialise();
	}

	// Get the modal


	// Get the button that opens the modal

	// Get the <span> element that closes the modal
	//var span = document.getElementsByClassName("close")[0];

	// When the user clicks the button, open the modal
	function openmodal() {
		var modal = document.getElementById('myModal');
		modal.style.display = "block";
		generatePlaylistModal();
	}

	function opensearchmodal() {
		var modal = document.getElementById('searchmodal');
		modal.style.display = "block";
	}

	function closemodal() {
		var modal = document.getElementById('myModal');
		modal.style.display = "none";
	}

	function closesearchmodal() {
		var modal = document.getElementById('searchmodal');
		modal.style.display = "none";
	}
	//Close modal when he presses anywhere outside the modal
	window.onclick = function(event) {
		var modal = document.getElementById('myModal');
		if (event.target == modal) {
			modal.style.display = "none";
		}
		modal = document.getElementById("newplaylistmodal");
		if (event.target == modal) {
			modal.style.display = "none";
		}
		modal = document.getElementById("statusmodal");
		if (event.target == modal) {
			modal.style.display = "none";
		}
		modal = document.getElementById('searchmodal');
		if (event.target == modal) {
			modal.style.display = "none";
		}
	};
</script>
<style>
	/* The Modal (background) */
	.modal-playlist {
		display: none;
		/* Hidden by default */
		position: fixed;
		/* Stay in place */
		z-index: 1;
		/* Sit on top */
		padding-top: 100px;
		/* Location of the box */
		left: 0;
		top: 0;
		width: 100%;
		/* Full width */
		height: 100%;
		/* Full height */
		overflow: auto;
		/* Enable scroll if needed */
		background-color: rgb(0, 0, 0);
		/* Fallback color */
		background-color: rgba(0, 0, 0, 0.4);
		/* Black w/ opacity */
	}

	/* Modal Content */
	.modal-content-playlist {
		background-color: #fefefe;
		margin: auto;
		padding: 20px;
		border: 1px solid #888;
		width: 80%;
	}

	/* The Close Button */
	.close-modal {
		color: #aaaaaa;
		float: right;
		font-size: 28px;
		font-weight: bold;
	}

	.close-modal:hover,
	.close-modal:focus {
		color: #000;
		text-decoration: none;
		cursor: pointer;
	}
</style>

<body onload="doAllInitialization();" onoffline="updateinternetfailure('offline');" ononline="updateinternetfailure('online');">
	<section class="content">
		<div class="content__left">
			<section class="navigation">
				<!-- Main -->
				<div class="navigation__list">
					<div class="navigation__list__header" role="button" data-toggle="collapse" href="#main" aria-expanded="true" aria-controls="main">
						Main
					</div>
					<!--<div class="collapse in" id="main">
                            <a href="#" class="navigation__list__item">
                            <i class="material-icons">radio</i>
                            <span>Radio</span>
                            </a>
                        </div>-->
				</div>
				<!-- Your Music -->
				<div class="navigation__list">
					<div class="navigation__list__header" role="button" data-toggle="collapse" href="#yourMusic" aria-expanded="true" aria-controls="yourMusic">
						Your Music
					</div>
					<div class="collapse in" id="yourMusic">
						<a href="javascript:initialise();" class="navigation__list__item">
							<i class="material-icons">album</i>
							<span>Play All Songs</span>
						</a>
						<a href="#currentplaylistimage" class="navigation__list__item">
							<i class="material-icons">queue_music</i>
							<span>Current Playlist</span>
						</a>
						<a href="#related-artists" class="navigation__list__item">
							<i class="material-icons">person</i>
							<span>Artists</span>
						</a>
					</div>
				</div>
				<!-- Playlists -->
				<div class="navigation__list">
					<div class="navigation__list__header" role="button" data-toggle="collapse" href="#playlists" aria-expanded="true" aria-controls="playlists">
						Playlists
					</div>
					<div class="tracks" id="playlists">
						<p>Sign in to create and play playlist</p>
						<!--Dynamically generates playlist of user-->
					</div>
				</div>
				<!-- / -->
			</section>
			<section class="playlist">
				<button onclick="addNewPlaylist();">
					New Playlist
				</button>
			</section>
			<section class="playlist">
				<button onclick="opensearchmodal();">
					Search for a song
				</button>
			</section>
		</div>
		<div class="content__middle">
			<div class="artist is-verified">
				<div id="artistbackgroundimage" class="artist__header">
					<div class="artist__info">
						<div class="profile__img">
							<img id="artistimage" src="http://quotepixel.com/images/authors/170w/unknown_quotes.jpg" alt="Artist-Name" />
						</div>
						<div class="artist__info__meta">
							<div class="artist__info__type">Artist</div>
							<div id="currenttopartistplayingname" class="artist__info__name">Loading Artist</div>
							<div class="artist__info__actions">
								<button class="button-dark" onclick="playSameArtistSongs('default');">
									<i class="ion-ios-play"></i>
									Play All Songs of this Artist
								</button>
							</div>
						</div>
					</div>
					<div class="artist__listeners">
						<div class="artist__listeners__count"></div>
						<div class="artist__listeners__label"></div>
					</div>
				</div>
				<div class="artist__content">
					<div class="tab-content">
						<!-- Overview -->
						<div role="tabpanel" class="tab-pane active" id="artist-overview">
							<div class="overview">
								<div class="overview__artist">
									<!-- Latest Release-->

									<!-- Popular-->
									<div class="section-title">Popular</div>
									<div class="tracks" id="songListContainer">
										<!--Popular songs are dynamically generated on web-->
									</div>
									<!--<button class="show-more button-light">Show 5 More</button>-->
									<!-- / -->
								</div>
								
								<div class="overview__albums">
									<div class="overview__albums__head">
										<span class="section-title">Currently Playing Playlist</span>
										<div class="pagination">
												<a onclick="moveToPreviousPage();">&laquo;</a>
												<a onclick="moveToPage(this.innerHTML);" class="active" id="pageindex1top">1</a>
												<a onclick="moveToPage(this.innerHTML);" id="pageindex2top">2</a>
												<a onclick="moveToPage(this.innerHTML);" id="pageindex3top" >3</a>
												<a onclick="moveToPage(this.innerHTML);" id="pageindex4top">4</a>
												<a onclick="moveToPage(this.innerHTML);" id="pageindex5top">5</a>
												<a onclick="moveToPage(this.innerHTML);" id="pageindex6top">6</a>
												<a onclick="moveToNextPage();">&raquo;</a>
										</div>
									</div>
									<div class="album">
										<div class="album__info">
											<div class="album__info__art">
												<img id="currentplaylistimage" src="http://quotepixel.com/images/authors/170w/unknown_quotes.jpg" alt="Currently playing song" />
											</div>
											<div class="album__info__meta">
												<div id="currentplayingplaylistname" class="album__name">All Songs</div>
											</div>
											<div>
												<button id="x" class="track__explicit" onclick="openmodal();" style="background:#1ed760; display: none">
													<span class="track__label" style="color:#fff">Add to Playlist</span>
												</button>
												<!-- The Modal -->
												<div id="myModal" class="modal-playlist">
													<!-- Modal content -->
													<div class="modal-content-playlist" style="background: #373737;">
														<h1 style="color: white">Select which playlist to add to</h1>
														<span class="close-modal" onclick="closemodal();">&times;</span>
														<div class="tracks" style="background: #282828;" id="userplaylistcontainer">
															<div class="track" style="display: flex;flex-flow: row wrap;">
																<p class="track__title" style="color: white">Abcd</p>
																<button class="track__explicit" style="background:#1ed760;" id="Abcd"><span style="color:#fff">Click to add to playlist</span></button>
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>
										<div class="album__tracks">
											<div class="tracks" id="playListContainer">
												<!--Here popular_and_playListSsongListGenerator puts all the songs-->
												<div class="tracks__heading">
													<div class="tracks__heading__title">Song-Artist</div>
													<div class="tracks__heading__length">
														<i class="ion-ios-stopwatch-outline"></i>
													</div>
													<div class="tracks__heading__popularity">
														<i class="ion-thumbsup"></i>
													</div>
												</div>
											</div>
										</div>
										<div class="album_footer">
											<div class="pagination">
												<a onclick="moveToPreviousPage();">&laquo;</a>
												<a onclick="moveToPage(this.innerHTML);" class="active" id="pageindex1down">1</a>
												<a onclick="moveToPage(this.innerHTML);" id="pageindex2down">2</a>
												<a onclick="moveToPage(this.innerHTML);" id="pageindex3down" >3</a>
												<a onclick="moveToPage(this.innerHTML);" id="pageindex4down">4</a>
												<a onclick="moveToPage(this.innerHTML);" id="pageindex5down">5</a>
												<a onclick="moveToPage(this.innerHTML);" id="pageindex6down">6</a>
												<a onclick="moveToNextPage();">&raquo;</a>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
						<!-- / -->
						<!-- Related Artists -->
						<div id="related-artists">
							<div class="media-cards">
								<div id="AR12F2S1187FB56EEF" onclick="playSameArtistSongs(this.id);" class="media-card">
									<div class="media-card__image" style="background-image: url(https://cps-static.rovicorp.com/3/JPG_170/MI0003/877/MI0003877705.jpg?partner=allrovi.com);">
										<i class="ion-ios-play"></i>
									</div>
									<a class="media-card__footer">Aerosmith</a>
								</div>
								<div id="ARDVZTE1187FB5A0A1" onclick="playSameArtistSongs(this.id);" class="media-card">
									<div class="media-card__image" style="background-image: url(https://cps-static.rovicorp.com/3/JPG_170/MI0004/107/MI0004107693.jpg?partner=allrovi.com);">
										<i class="ion-ios-play"></i>
									</div>
									<a class="media-card__footer">Bon Jovi</a>
								</div>
								<div id="AR9W3X91187FB3994C" onclick="playSameArtistSongs(this.id);" class="media-card">
									<div class="media-card__image" style="background-image: url(https://cps-static.rovicorp.com/3/JPG_170/MI0003/423/MI0003423644.jpg?partner=allrovi.com);">
										<i class="ion-ios-play"></i>
									</div>
									<a class="media-card__footer">Phil Collins</a>
								</div>
								<div id="ARE8GLF1187FB52532" onclick="playSameArtistSongs(this.id);" class="media-card">
									<div class="media-card__image" style="background-image: url(https://cps-static.rovicorp.com/3/JPG_170/MI0004/058/MI0004058376.jpg?partner=allrovi.com);">
										<i class="ion-ios-play"></i>
									</div>
									<a class="media-card__footer">Red Hot Chili Peppers</a>
								</div>
								<div id="AR6PJ8R1187FB5AD70" onclick="playSameArtistSongs(this.id);" class="media-card">
									<div class="media-card__image" style="background-image: url(https://cps-static.rovicorp.com/3/JPG_170/MI0003/705/MI0003705442.jpg?partner=allrovi.com);">
										<i class="ion-ios-play"></i>
									</div>
									<a class="media-card__footer">Shakira</a>
								</div>
								<div id="ARD8JVH1187FB4DA04" onclick="playSameArtistSongs(this.id);" class="media-card">
									<div class="media-card__image" style="background-image: url(https://cps-static.rovicorp.com/3/JPG_170/MI0001/403/MI0001403029.jpg?partner=allrovi.com);">
										<i class="ion-ios-play"></i>
									</div>
									<a class="media-card__footer">Bad Company</a>
								</div>
								<div id="ARVN9FZ1187FB393F1" onclick="playSameArtistSongs(this.id);" class="media-card">
									<div class="media-card__image" style="background-image: url(https://cps-static.rovicorp.com/3/JPG_170/MI0004/394/MI0004394413.jpg?partner=allrovi.com);">
										<i class="ion-ios-play"></i>
									</div>
									<a class="media-card__footer">Snow Patrol</a>
								</div>
								<div id="AROF4LP1187FB41C51" onclick="playSameArtistSongs(this.id);" class="media-card">
									<div class="media-card__image" style="background-image: url(https://cps-static.rovicorp.com/3/JPG_170/MI0003/274/MI0003274595.jpg?partner=allrovi.com);">
										<i class="ion-ios-play"></i>
									</div>
									<a class="media-card__footer">Selena</a>
								</div>
							</div>
						</div>
						<!-- / -->
					</div>
				</div>
			</div>
		</div>
		<div class="content__right">
			<div class="social">
				<div class="section-title">Songs from the same artist</div>
				<div class="tracks" id="songsBySameArtistContainer">

				</div>
				<div class="section-title">
					<h3>Recommended Songs</h3>
				</div>
				<div class="btn-group">
					<h5><span style="color: white;">Recommendation based on:</span></h5>
					<!--<button class="btn-primary">RNN</button>
					<button class="btn-primary">KNN</button>
					<button class="btn-primary">RNN&KNN</button>-->
					<form id="recommendationChoice">
						<label class="radio-inline">
							<input type="radio" name="optradio" value="RNN&KNN" checked><span style="color: white;">RNN&KNN</span>
						</label>
						<label class="radio-inline">
							<input type="radio" name="optradio" value="RNN"><span style="color: white;">RNN</span>
						</label>
						<label class="radio-inline">
							<input type="radio" name="optradio" value="KNN"><span style="color: white;">KNN</span>
						</label>
					</form>
				</div>
				<div class="tracks" id="recommendedSongsContainer">

				</div>
				<!--<button class="button-light"></button>-->
			</div>
		</div>
		<div class="current_track">
			<section class="playing">
				<img id="songimgsource" class="song_image" src="http://quotepixel.com/images/authors/170w/unknown_quotes.jpg" alt="Song-Cover Image" />
			</section>
			<div class="current-track__actions">
				<div id="playprevious" class="playforwardbackward">
					<button id="playprevioussong" onclick="playprevioussong();"><i class="material-icons">skip_previous</i></button>
				</div>
				<div id="showplay" class="playforwardbackward">
					<button id="playsong" onclick="songplayedorpaused('play');"><i class="material-icons">play_arrow</i></button>
				</div>
				<div id="showpause" style="display: none" class="playforwardbackward">
					<button id="pausesong" onclick="songplayedorpaused('pause');"><i class="material-icons">pause</i></button>
				</div>
				<div id="playnext" class="playforwardbackward">
					<button id="playnextsong" onclick="playnextsong();"><i class="material-icons">skip_next</i></button>
				</div>
			</div>
			<div class="current-track__progress">
				<div class="current-track__progress__start">
					<p id="song_current_time">0:01</p>
				</div>
				<div class="current-track__progress__bar">
					<!--<audio src="../audio/05 - Track 05.mp3" id="audiosource"></audio>-->
					<audio id="audiosource">
						<source id="currentaudiosource" src="../audio/05 - Track 05.mp3" type="audio/mpeg">
						Your browser does not support the audio element.
					</audio>
					<progress id="seekbar" value="0" max="1" style="width: 100%;"></progress>
					<!--<div id="song-progress"></div>-->
				</div>
				<div id="song_remaining_time" class="current-track__progress__finish">3:07</div>
			</div>
		</div>
		<p id="songloadstatus" style="color: white;display: none">Loading...Wait</p>
		<div class="playing__song">
			<div class="song_name_and_artist">
				<a id="songname" class="playing__song__name"><span style="color: #fff">Track:</span>Loading song title</a>
				<a id="songartistname" class="playing__song__artist"><span style="color: #fff">Artists:</span>Loading Artist Name</a>
			</div>
		</div>


		<!--Modal which pops up when new playlist is created  -->
		<div id="newplaylistmodal" class="modal-playlist">
			<!-- Modal content -->
			<div class="modal-content-playlist" style="background: #373737;">
				<h2 style="color: white">Enter a name to your new playlist</h2>
				<span class="close-modal" onclick="closeplaylistmodal();">&times;</span>
				<div class="tracks" style="background: #282828;">
					<div class="track" style="display: flex;flex-flow: row wrap;justify-content: space-between;">
						<input type="text" style="width: 100%" id="newplaylistNameHolder">
						<button class="track__explicit" style="background:#1ed760;" id="createplaylistbutton" onclick="addPlaylistNametoDatabase(document.getElementById('newplaylistNameHolder').value);"><span style="color:#fff">Click to create playlist</span></button>
					</div>
				</div>
			</div>
		</div>


		<!--Status Modal used for various purposes-->
		<div id="statusmodal" class="modal-playlist">
			<div class="modal-content-playlist" style="background: white;">
				<span class="close-modal" onclick="closestatusmodal();">&times;</span>
				<h3 id="statustext"></h3>
			</div>
		</div>

		<!-- Modal for search song -->
		<div id="searchmodal" class="modal-playlist">
			<!-- Modal content -->
			<div class="modal-content-playlist" style="background: #373737;">
				<h2 style="color: white">Enter a song title to search</h2>
				<span class="close-modal" onclick="closesearchmodal();">&times;</span>
				<div class="tracks" style="background: #282828;">
					<div class="track" style="display: flex;flex-flow: row wrap;justify-content: space-between;">
						<input type="text" style="width: 100%" onkeyup="searchdatabase(event,this.value);" />
					</div>
				</div>
				<!-- Drop down for search -->
				<div class="tracks" id="myDropdown" style="background: #282828;">
					<!-- Dynamically generate dropdown for searched songs-->
				</div>
			</div>
		</div>

	</section>
</body>
<script>
	$('#recommendationChoice input').on('change', function() {
		fillRecommendedSongs(global_playingSongId);
	});

	function playnextsong() {
		if (currentsongarrayindex == musicpaircontentarray.length - 1) {
			currentsongarrayindex = 0;
		} else {
			currentsongarrayindex = currentsongarrayindex + 1;
		}
		initialiseplay("play");
	}
	$('#audiosource').on('timeupdate', function() {
		$('#seekbar').attr("value", this.currentTime / this.duration);
		var runningtime = this.currentTime;
		var seconds = Math.trunc(runningtime);
		var minutes = 0;
		if (seconds > 59) {
			minutes = Math.trunc(seconds / 60);
			seconds = seconds % 60;
		}
		var str;
		if (seconds < 10) {
			str = minutes + ":0" + seconds;
			document.getElementById("song_current_time").innerHTML = str;
		} else {
			str = minutes + ":" + seconds;
			document.getElementById("song_current_time").innerHTML = str;
		}
		if (seconds > 5) {
			if (document.getElementById("song_remaining_time").innerHTML == str) {
				playnextsong(); //Automatically play next song after current song is played
			}
		}
	});

	function playprevioussong() {
		if (currentsongarrayindex != 0) {
			currentsongarrayindex = currentsongarrayindex - 1;
		} else {
			currentsongarrayindex = musicpaircontentarray.length - 1;
		}
		initialiseplay("play");
	}
	function moveToPage(indexnumber){
		var celement=document.getElementById("pageindex"+(global_paginationCurrentIndex-global_paginationStartIndex+1)+"down");
		celement.classList.remove("active");
		celement=document.getElementById("pageindex"+(global_paginationCurrentIndex-global_paginationStartIndex+1)+"top");
		celement.classList.remove("active");
		global_paginationCurrentIndex=parseInt(indexnumber);
		var  nextelement=document.getElementById("pageindex"+(global_paginationCurrentIndex-global_paginationStartIndex+1)+"down");
		nextelement.classList.add("active");
		nextelement=document.getElementById("pageindex"+(global_paginationCurrentIndex-global_paginationStartIndex+1)+"top");
		nextelement.classList.add("active");
		initialise();
	}
	function moveToNextPage() {
		var celement=document.getElementById("pageindex"+(global_paginationCurrentIndex-global_paginationStartIndex+1)+"down");
		celement.classList.remove("active");
		celement=document.getElementById("pageindex"+(global_paginationCurrentIndex-global_paginationStartIndex+1)+"top");
		celement.classList.remove("active");
		global_paginationCurrentIndex = global_paginationCurrentIndex + 1;
		if (global_paginationCurrentIndex > global_paginationEndIndex) {
			if (global_paginationEndIndex > 45) {
				return;
			}
			incrementPageIndexes();
			global_paginationStartIndex = global_paginationStartIndex + 1;
			global_paginationEndIndex = global_paginationEndIndex + 1;
		}
		var  nextelement=document.getElementById("pageindex"+(global_paginationCurrentIndex-global_paginationStartIndex+1)+"down");
		nextelement.classList.add("active");
		nextelement=document.getElementById("pageindex"+(global_paginationCurrentIndex-global_paginationStartIndex+1)+"top");
		nextelement.classList.add("active");
		initialise();
		console.log("Move to next page");
	}
	
	function moveToPreviousPage() {
		if (global_paginationCurrentIndex == 1 ) {
				return;
			}
		var celement=document.getElementById("pageindex"+(global_paginationCurrentIndex-global_paginationStartIndex+1)+"down");
		celement.classList.remove("active");
		celement=document.getElementById("pageindex"+(global_paginationCurrentIndex-global_paginationStartIndex+1)+"top");
		celement.classList.remove("active");
		global_paginationCurrentIndex = global_paginationCurrentIndex - 1;
		if (global_paginationCurrentIndex < global_paginationStartIndex) {
			decrementPageIndexes();
			global_paginationStartIndex = global_paginationStartIndex - 1;
			global_paginationEndIndex = global_paginationEndIndex - 1;
		}
		var  nextelement=document.getElementById("pageindex"+(global_paginationCurrentIndex-global_paginationStartIndex+1)+"down");
		nextelement.classList.add("active");
		nextelement=document.getElementById("pageindex"+(global_paginationCurrentIndex-global_paginationStartIndex+1)+"top");
		nextelement.classList.add("active");
		initialise();
		console.log("Move to previous page");
	}

	function incrementPageIndexes() {
		for(var j=1;j<7;j++){
			var pre=document.getElementById("pageindex"+j+"down").innerHTML;
			pre=parseInt(pre)+1;
			document.getElementById("pageindex"+j+"down").innerHTML=pre;
			document.getElementById("pageindex"+j+"top").innerHTML=pre;
		}
	}
	
	function decrementPageIndexes() {
		for(var j=1;j<7;j++){
			var pre=document.getElementById("pageindex"+j+"down").innerHTML;
			pre=parseInt(pre)-1;
			document.getElementById("pageindex"+j+"down").innerHTML=pre;
			document.getElementById("pageindex"+j+"top").innerHTML=pre;
		}
	}

	function initialise() {
		musicidarray = [];
		musicpaircontentarray = [];
		//Retreive all music value pairs
		var sequence_start = 50 * (global_paginationCurrentIndex - 1);
		var sequence_end = 50 + sequence_start;
		db.collection("MusicIdNamePairs").where("FireStoreMusicValueModel.sequence_number", ">=", sequence_start).where("FireStoreMusicValueModel.sequence_number", "<=", sequence_end).get().then((querySnapshot) => {
			querySnapshot.forEach((doc) => {
				console.log(")))))))))))=>" + doc.data().FireStoreMusicValueModel.artist_name);
				musicidarray.push(doc.id);
				console.log("Ids are:" + doc.id);
				musicpaircontentarray.push(doc);
			});
			console.log(musicpaircontentarray.length);
			var cont = document.getElementById("playListContainer");
			while (cont.hasChildNodes()) {
				cont.removeChild(cont.firstChild);
			}
			document.getElementById("currentplayingplaylistname").innerHTML = "All Songs";
			currentlyPlayingListGenerator();
			currentsongarrayindex = 0;
			initialiseplay("null");
		});
	}

	function setSongDetails(songname, artistname, imageurlsmall, imageurlLarge, song_id) {
		document.getElementById("songimgsource").src = imageurlsmall;
		document.getElementById("songname").innerHTML = "<span style='color: #fff'>Track:</span>" + songname;
		document.getElementById("songartistname").innerHTML = "<span style='color: #fff'>Artists:</span>" + artistname;
		console.log("*********************************==>" + imageurlLarge);
		document.getElementById("artistbackgroundimage").style.backgroundImage = "url('" + imageurlLarge + "')";
		console.log("global playing song id is: " + global_playingSongId);
		if (global_playingSongId != null) {
			if (document.getElementById("animation" + global_playingSongId) != null) {
				document.getElementById("animation" + global_playingSongId).style.display = "none";
			}
		}
		if (document.getElementById("animation" + song_id) != null) {
			document.getElementById("animation" + song_id).style.display = "inline";
		} else {
			if (global_playingSongId != null) {
				if (document.getElementById("animation" + global_playingSongId) != null) {
					document.getElementById("animation" + global_playingSongId).style.display = "none";
				}
			}
		}
		global_playingSongId = song_id;
		console.log("global playing song id is: " + global_playingSongId);
	}

	function playSongById(url, isplay) {
		songloaded = "false";

		var pathReference = storage.refFromURL(url);
		//var pathReference = storageRef.child('/01.HAGE SUMMANE.mp3');
		//var pathReference = storage.ref('gs://webproject-ab93a.appspot.com/01.HAGE SUMMANE.mp3');

		// Get the download URL
		pathReference.getDownloadURL().then(function(url) {
			var audio = document.getElementById("audiosource");
			var source = document.getElementById("currentaudiosource");

			source.src = url;
			audio.load();
			if (isplay == "play") {
				audio.play();
				document.getElementById('showplay').style.display = "none";
				document.getElementById('showpause').style.display = "block";
			}
			songloaded = "true";
			document.getElementById("songloadstatus").style.display = "none";
			$("#audiosource").on("loadedmetadata", function() {
				var song_duration = Math.trunc(audio.duration);
				var duration_minutes = 0;
				var duration_seconds = 0;
				if (song_duration > 59) {
					duration_minutes = Math.trunc(song_duration / 60);
					duration_seconds = song_duration % 60;
				}
				if (duration_seconds < 10) {
					document.getElementById("song_remaining_time").innerHTML = duration_minutes + ":0" + duration_seconds;
				} else {
					document.getElementById("song_remaining_time").innerHTML = duration_minutes + ":" + duration_seconds;
				}

			});

		}).catch(function(error) {
			openstatusmodal("caught", "red");
			// A full list of error codes is available at
			// https://firebase.google.com/docs/storage/web/handle-errors
			switch (error.code) {
				case 'storage/object-not-found':
					openstatusmodal(error.message, "red");
					// File doesn't exist
					break;

				case 'storage/unauthorized':
					openstatusmodal(error.message, "red");
					// User doesn't have permission to access the object
					break;

				case 'storage/canceled':
					openstatusmodal(error.message, "red");
					// User canceled the upload
					break;

				case 'storage/unknown':
					openstatusmodal(error.message, "red");
					// Unknown error occurred, inspect the server response
					break;
			}
		});
	}
</script>

</html>